---
title: 안정적인 백엔드 운영과 개발 기법
date: 2022-11-24 17:18:00
categories: [Session, NHN FORWARD 2022]
tags: [til, backend]
---

현재 Dooray 에서는 개발 담당자가 서비스를 운영한다.
- 장점
	- 빠른 장애 대응(예외로그 보면 개발자가 바로 눈치채기때문)
	- 최적의 서버 구성 ( 그 기능을 제일 잘 아는 건 개발자)
	- 설계/개발 단계에서 운영을 고려한다.
- 단점
	- 불안하고.. 피로가 쌓이고.. 
	- 개발자는 운영전문가가 아니다. 

---

개발자가 피로도 적게 안정적으로 백엔드를 운영하기 위해 

## 1. 자동-재시작
서버의 재시작이 필요한 경우?
- Garbage collection death spiral : heap과 관련된 이슈
	- RestApi로 요청이 많이 왔을때 
	- 싱글톤에 너무 많은 걸 태울때
- 스레드 차단이 필요한 경우
- 서버에서 데드락

JVM 프로세스는 outOfMemory에도 죽지않는다.
%p -> pid를 떨군다

쿠버네티스의 livenessProbe: service를 통해 요청이 가고 kublet이 코드 체크 livenessProbe기 fail되면 삭제한다.

-> 일시적인 장애는 대응 가능, 무중단 서비스 유지


### 1-2. 과도한 부하를 견디는방법
cascading failures : 일부서버 한 대의 과부화가 다른 서버의 문제로 이어지면서 이슈가 점진적으로 연결된 서버에 오류를 유발한다.

사례) 
메일 관련된 장애를 겪음 -> 전면 장애

측정)
가시화 -> sptring boot Actuator 활용 
active Thread 수가 어떤 시점에 폭등하는 것을 확인 + 메일 수신건 수도 어떤 시점에 폭등하는 것으 ㄹ확인

측정결과)
Thread Pool 을 모두 사용함
수신량이 폭증함
메일 수신량과는 별개로 메일 하나의 용량에 따라 에러가 발생

대응)
1. scale up/out : 돈
	1. 일정시간에만 급증하는 수신을 위해 리소스를 향상시키는 건 비용 이슈
2. Message Broker로 지연처리
	1. SMTP가 메일 수신을 보장 -> 실패시 계속 retry -> role 이 중복된다.
3. Auto Scale 사용
	1. 단시간 폭증요청을 Auto Scale이 커버 불가: 이미 불편을 겪고 scale up 된다.
4. Circuit Breaker Pattrehn
	1. 사용자에게 오류가 보여짐 -> 안정적이지 않음
5. 수신거부
	1.  429 에러, 응답을 거부한다. 

적용가능한 API를 선정해서 429처리해서 응답거부를 한다.
사용자 interaction이 없는 api로 선정

429를 위한 조건

### 1-3. 백엔드에서 Http Cache 활용
cache control 헤더:
Etag Header : 
server가 클라이언트를 구현할때 Apache HttpClient-Cache 


### 1-4. 소켓
TCP 기반으로 클라이언트용 

그래서 결국엥ㄴ 
